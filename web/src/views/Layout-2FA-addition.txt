// Add these imports to Layout.vue script section
import { enable2FA, verify2FA, disable2FA } from '../api'

// Add these state variables
const show2FASetupModal = ref(false)
const show2FADisableModal = ref(false)
const loading2FA = ref(false)
const twoFactorEnabled = ref(false)
const twoFactorSecret = ref('')
const qrCode = ref('')
const verifyCode = ref('')
const twoFactorVerified = ref(false)
const backupCodes = ref<string[]>([])
const disable2FAPassword = ref('')

// Add these functions
const start2FASetup = async () => {
  loading2FA.value = true
  try {
    const res: any = await enable2FA()
    twoFactorSecret.value = res.secret
    qrCode.value = res.qrcode
    show2FASetupModal.value = true
  } catch (e: any) {
    message.error(e.response?.data?.error || '启用 2FA 失败')
  } finally {
    loading2FA.value = false
  }
}

const verify2FACode = async () => {
  if (!verifyCode.value || verifyCode.value.length !== 6) {
    message.error('请输入 6 位验证码')
    return
  }

  loading2FA.value = true
  try {
    const res: any = await verify2FA(verifyCode.value)
    backupCodes.value = res.backup_codes || []
    twoFactorVerified.value = true
    twoFactorEnabled.value = true
    message.success('2FA 已启用')
  } catch (e: any) {
    message.error(e.response?.data?.error || '验证码错误')
  } finally {
    loading2FA.value = false
  }
}

const finish2FASetup = () => {
  show2FASetupModal.value = false
  twoFactorVerified.value = false
  twoFactorSecret.value = ''
  qrCode.value = ''
  verifyCode.value = ''
  backupCodes.value = []
  loadProfile() // Reload profile to get updated 2FA status
}

const cancel2FASetup = () => {
  show2FASetupModal.value = false
  twoFactorVerified.value = false
  twoFactorSecret.value = ''
  qrCode.value = ''
  verifyCode.value = ''
}

const confirmDisable2FA = async () => {
  if (!disable2FAPassword.value) {
    message.error('请输入密码')
    return
  }

  loading2FA.value = true
  try {
    await disable2FA(disable2FAPassword.value)
    twoFactorEnabled.value = false
    show2FADisableModal.value = false
    disable2FAPassword.value = ''
    message.success('2FA 已禁用')
  } catch (e: any) {
    message.error(e.response?.data?.error || '禁用失败')
  } finally {
    loading2FA.value = false
  }
}

// Update loadProfile function to include two_factor_enabled check
const loadProfile = async () => {
  try {
    const user: any = await getProfile()
    profileForm.value = {
      email: user.email || '',
    }
    twoFactorEnabled.value = user.two_factor_enabled || false
  } catch {
    message.error('加载用户信息失败')
  }
}
